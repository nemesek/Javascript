<html>
  <head>
    <title>A function to bind event handlers with tracking</title>
  </head>
  <body>
      <script type="text/javascript">
        (function(){
          //establishes scoped storage
          var cache = {},
              guidCounter = 1,
              expando = "data" + (new Date).getTime();

          this.getData = function(elem){
            var guid = elem[expando];
            if(!guid){
              guid = elem[expando] = guidCounter++;
              cache[guid] = {};
            }
            return cache[guid];
          };

          this.removeData = function(elem){
            var guid = elem[expando];
            if(!guid) return;
            delete cache[guid];
            try{
              delete elem[exapndo];
            }
            catch(e){
              if(elem.removeAttribute){
                elem.removeAttribute(expando);
              }
            }
          };
        })();


        (function(){
          var nextGuid = 1;

          this.addEvent = function(elem, type, fn){
            var data = getData(elem);

            // creates handler storage
            if(!data.handlers) data.handlers = {};

            // creates array by type
            if(!data.handlers[type])
              data.handlers[type] = {};

            // Marks instrumented functions
            if(!fn.guid) fn.guid = nextGuid++;

            // Adds handler to list
            data.handlers[type].push(fn);

            // creates uber-handler(dispatcher)
            if(!data.dispatcher){
              data.disabled = false;
              data.dispatcher = function(event){
                if(data.disabled) return;
                event = fixEvent(event);

                // calls registered handlers
                var handlers = data.handlers[event.type];
                if(handlers){
                  for(var n = 0; n < handlers.length; n++){
                    handlers[n].call(elem, event);
                  }
                }
              };
            }

            if(data.handlers[type].length == 1){
              if(document.addEventListener){
                elem.addEventListener(type, data.dispatcher, false);
              }
              else if(document.attachEvent){
                elem.attachEvent("on" + type, data.dispatcher);
              }
            }
          };
        })();

        function fixEvent(event){
          // Predefines often used functions
          function returnTrue(){return true;}
          function returnFalse(){return false;}

          // tests if fixing up is needed
          if(!event || !event.stopPropagation){
            var old = event || window.event;

            // Clone the old object so that we can modify the values
            event = {};
            // Clones existing properties
            for(var prop in old){
              event[prop] = old[prop];
            }

            // The event occured on this element
            if(!event.target){
              event.targt = event.srcElement || document;
            }

            // Handle which other element the event is related to
            event.relatedTarget = event.fromElement === event.target ? event.toElement : event.fromElement;

            // Stop the default browser action
            event.preventDefault = function(){
              event.returnValue = false;
              event.isDefaultPrevented = returnTrue;
            };

            event.isDefaultPrevented = returnFalse;

            // Stop the event from bubbling
            event.stopPropagation = function(){
              event.cancelBubble = true;
              event.isPropagationStopped = returnTrue;
            };

            event.isPropagationStopped = returnFalse;

            // Stop the event from bubblingand executing other handlers
            event.stopImmediatePropagation = function(){
              this.isImmediatePropagationStopped = returnTrue;
              this.stopPropagation();
            };

            event.isImmediatePropagationStopped = returnFalse;

            // Handle mouse position
            if(event.clientX != null){
              var doc = document.documentElement, body = document.body;

              event.pageX = event.clientX + (doc && doc.scrollLeft || body && body.scrollLeft || 0) -
                            (doc && doc.clientLeft || body && body.clientLeft || 0);
              event.pageY = event.clientY + (doc && doc.scrollTop || body && body.scrollTop || 0) -
                            (doc && doc.clientTop || body && body.clientTop || 0);
            }

            // Handle key presses
            event.which = event.charCode || event.keyCode;

            // Fix button for mouse clicks:
            // 0 == left; 1 == middle; 2 == right
            if(event.button != null){
              event.button = (event.button & 1 ? 0 :
               (event.button & 4 ? 1:
                 (event.button & 2 ? 2 : 0)))
            }
          }
          // returns fixed up instance
          return event;
        }
      </script>
  </body>
</html>
