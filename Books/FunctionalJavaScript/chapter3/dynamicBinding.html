<html>
  <head>
    <title>Dynamic Binding</title>
    <script type="text/javascript" src="http://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.6.0/underscore.js"></script>
  </head>
  <body>
    <script type="text/javascript">
      var globals = {};

      function makeBindFun(resolver){
        return function(k,v){
          var stack = globals[k] || [];
          globals[k] = resolver(stack,v);
          return globals;
        };
      }

      var stackBinder = makeBindFun(function(stack,v){
        stack.push(v);
        return stack;
      });

      var stackUnBinder = makeBindFun(function(stack){
        stack.pop();
        return stack;
      });

      var dynamicLookup = function(k){
        var slot = globals[k] || [];
        return _.last(slot);
      };

      stackBinder('a',1);
      stackBinder('b', 100);
      console.log(dynamicLookup('a'));
      console.log(globals);

      stackBinder('a', '*');
      console.log(dynamicLookup('a'));
      console.log(globals);
      stackUnBinder('a');
      console.log(dynamicLookup('a'));

      function f(){return dynamicLookup('a');}
      function g(){stackBinder('a', 'g'); return f();}

      console.log(f());
      console.log(g());

      function globalThis(){return this;};
      console.log(globalThis());

      console.log(globalThis.call('barnabas'));
      console.log(globalThis.apply('orsulak', []));

      // use underscore to fix this
      var nopeThis = _.bind(globalThis, 'nope');
      console.log(nopeThis.call('wat'));

    </script>
  </body>
</html>
